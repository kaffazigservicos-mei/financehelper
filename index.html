<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reserva de Emerg√™ncia ‚Äì Simulador Avan√ßado</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f7fb; margin:0; padding:20px; }
    .app { max-width:900px; margin:auto; background:#fff; padding:20px; border-radius:12px; }
    h1 { text-align:center; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; }
    label { font-size:13px; font-weight:bold; }
    input, select { padding:8px; width:100%; }
    button { padding:12px; margin-top:10px; font-weight:bold; cursor:pointer; }
    .alert { background:#fff3cd; padding:10px; border-radius:8px; margin-top:10px; }
    .ok { background:#dcfce7; }
    .reserva { background:#e0f2fe; padding:12px; border-radius:8px; margin-top:10px; font-weight:bold; }
    canvas { margin-top:20px; }
    table { width:100%; border-collapse:collapse; font-size:12px; margin-top:10px; }
    th, td { border:1px solid #ddd; padding:6px; text-align:right; }
    th { background:#f1f5f9; }
    .meta-row { background:#dcfce7; font-weight:bold; }
  </style>
</head>
<body>
<div class="app">
<h1>üõ° Simulador de Reserva de Emerg√™ncia</h1>

<div class="grid">
<!-- Campos de simula√ß√£o -->
  <div><label>Saldo inicial (R$)</label><input id="saldoInput" type="number" value="10000"></div>
  <div><label>Gasto mensal atual (R$)</label><input id="gastoInput" type="number" value="3000"></div>
  <div><label>Meses de reserva</label><input id="mesesInput" type="number" value="6"></div>
  <div><label>Aporte mensal (R$)</label><input id="aporteInput" type="number" value="500"></div>
  <div><label>Tipo de aporte</label>
    <select id="tipoAporteInput">
      <option value="nominal">Nominal (fixo)</option>
      <option value="real">Real (corrigido pela infla√ß√£o)</option>
    </select>
  </div>
  <div><label>Infla√ß√£o anual (%)</label><input id="ipcaInput" type="number" value="4"></div>
  <div><label>CDI / Selic anual (%)</label><input id="cdiInput" type="number" value="10"></div>
  <div><label>Choque inflacion√°rio (%)</label><input id="choqueInput" type="number" value="12"><small>Infla√ß√£o excepcional acima do normal (ex.: crises, choques econ√¥micos).</small></div>
  <div><label>Dura√ß√£o do choque (meses)</label><input id="choqueMesesInput" type="number" value="6"><small>Por quantos meses a infla√ß√£o elevada permanece antes de normalizar.</small></div>
  <div><label>Perda de renda</label>
<select id="perdaInput">
<option value="0">Nenhuma</option>
<option value="0.5">Parcial (50%)</option>
<option value="1">Total</option>
</select>
<small>Simula redu√ß√£o da capacidade de aporte durante a emerg√™ncia.</small>
</div>
  <div><label>Mostrar +6 meses ap√≥s meta</label>
    <select id="extraMeses">
      <option value="0">N√£o</option>
      <option value="6">Sim</option>
    </select>
  </div>
</div>

<button onclick="calcular()">Simular</button>

<div id="reservaValor" class="reserva" style="display:none"></div>
<div id="alerta" class="alert" style="display:none"></div>
<div id="meta" class="alert ok" style="display:none"></div>

<h3>üìä Evolu√ß√£o do Saldo</h3>
<p><strong>Eixo esquerdo:</strong> valores nominais (ilus√£o monet√°ria).<br>
<strong>Eixo direito:</strong> valores reais (poder de compra).</p>
<canvas id="grafico"></canvas>

<h3>üìö Entenda o que voc√™ est√° vendo</h3>
<section>
<p><strong>Saldo nominal</strong> cresce olhando apenas n√∫meros, sem descontar infla√ß√£o. Ele pode dar a falsa sensa√ß√£o de progresso.</p>
<p><strong>Saldo real</strong> mostra o verdadeiro poder de compra, corrigido pela infla√ß√£o. √â este que determina se a reserva √© suficiente.</p>
<p><strong>Aporte nominal</strong>: valor fixo ao longo do tempo. Com infla√ß√£o, o esfor√ßo real diminui (ilus√£o monet√°ria).</p>
<p><strong>Aporte real</strong>: o valor do aporte √© corrigido pela infla√ß√£o, preservando o esfor√ßo financeiro.</p>
<hr>
<p><strong>Choque inflacion√°rio</strong>: simula um per√≠odo excepcional de infla√ß√£o alta (ex.: crises, desvaloriza√ß√£o cambial).</p>
<p><strong>Dura√ß√£o do choque</strong>: quantos meses a infla√ß√£o elevada permanece antes de voltar ao patamar normal.</p>
<p><strong>Perda de renda</strong>: simula redu√ß√£o parcial ou total da capacidade de aportar durante a emerg√™ncia.</p>
</section>

<table id="tabela"></table>

<button onclick="exportarPDF()">üìÑ Exportar PDF</button>
</div>

<script>
'use strict';

let chart;
const moeda = v => isFinite(v)
  ? v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})
  : '‚Äî';

function calcular(){
  try{
    const saldoInicial = Number(document.getElementById('saldoInput')?.value)||0;
    const gastoBase = Number(document.getElementById('gastoInput')?.value)||0;
    const mesesReserva = Number(document.getElementById('mesesInput')?.value)||0;
    const aporteBase = Number(document.getElementById('aporteInput')?.value)||0;
    const tipoAporte = document.getElementById('tipoAporteInput')?.value||'nominal';
    const ipca = (Number(document.getElementById('ipcaInput')?.value)||0)/100/12;
    const cdi = (Number(document.getElementById('cdiInput')?.value)||0)/100/12;
    const choque = (Number(document.getElementById('choqueInput')?.value)||0)/100/12;
    const choqueMeses = Number(document.getElementById('choqueMesesInput')?.value)||0;
    const perda = Number(document.getElementById('perdaInput')?.value)||0;
    const extraMeses = Number(document.getElementById('extraMeses')?.value)||0;

    let saldoAtual = saldoInicial;
    let reservaNecessaria = 0;
    let labels=[], saldoNominal=[], saldoReal=[];
    let metaMes = null;

    let tabelaHTML='<tr><th>M√™s</th><th>Gasto corrigido</th><th>Saldo nominal</th><th>Saldo real</th></tr>';

    let i=1;
    const LIMITE=180;
    while(i<=LIMITE){
      const inflacaoMes = i<=choqueMeses ? choque : ipca;
      const gastoCorrigido = gastoBase*Math.pow(1+inflacaoMes,i);
      if(i<=mesesReserva) reservaNecessaria += gastoCorrigido;

      let aporteMes = aporteBase;
      if(tipoAporte==='real') aporteMes*=Math.pow(1+inflacaoMes,i);
      if(perda>0 && i<=mesesReserva) aporteMes*=(1-perda);

      saldoAtual = saldoAtual*(1+cdi)+aporteMes;
      const saldoRealMes = saldoAtual/Math.pow(1+inflacaoMes,i);

      labels.push(i);
      saldoNominal.push(saldoAtual);
      saldoReal.push(saldoRealMes);

      const metaClass = (metaMes===null && saldoRealMes>=reservaNecessaria) ? 'meta-row':'';
      tabelaHTML+=`<tr class="${metaClass}"><td>${i}</td><td>${moeda(gastoCorrigido)}</td><td>${moeda(saldoAtual)}</td><td>${moeda(saldoRealMes)}</td></tr>`;

      if(metaMes===null && saldoRealMes>=reservaNecessaria){
        metaMes=i;
        if(extraMeses===0) break;
      }
      if(metaMes!==null && i>=metaMes+extraMeses) break;
      i++;
    }

    document.getElementById('tabela').innerHTML=tabelaHTML;
    const rv=document.getElementById('reservaValor');
    rv.style.display='block';
    rv.innerText=`üí∞ Valor da reserva necess√°ria: ${moeda(reservaNecessaria)}`;

    if(chart){chart.destroy();chart=null;}
    const ctx=document.getElementById('grafico');
    if(!ctx) return;

    if(typeof Chart==='undefined'){
      document.getElementById('alerta').style.display='block';
      document.getElementById('alerta').innerText='‚ö†Ô∏è Biblioteca de gr√°fico n√£o carregada no ambiente de pr√©via. Em navegador real (GitHub Pages/local) o gr√°fico funciona normalmente.';
      return;
    }
    chart=new Chart(ctx,{
      type:'line',
      data:{labels,datasets:[
        {label:'Saldo nominal (ilus√£o)',data:saldoNominal,yAxisID:'yNominal',borderColor:'#fb923c',backgroundColor:'#fb923c',borderDash:[6,6]},
        {label:'Saldo real (realidade)',data:saldoReal,yAxisID:'yReal',borderColor:'#2563eb',backgroundColor:'#2563eb',borderWidth:3},
        metaMes?{label:'Meta',data:labels.map(m=>m===metaMes?reservaNecessaria:null),yAxisID:'yReal',borderColor:'#16a34a',borderWidth:2,pointRadius:0}:null
      ].filter(Boolean)},
      options:{responsive:true,scales:{
        yNominal:{position:'left',title:{display:true,text:'R$ Nominal'}},
        yReal:{position:'right',grid:{drawOnChartArea:false},title:{display:true,text:'R$ Real'}}
      }}
    );

    const alerta=document.getElementById('alerta');
    alerta.style.display= tipoAporte==='nominal'?'block':'none';
    alerta.innerText='‚ö†Ô∏è Aporte nominal pode criar ilus√£o de progresso.';

    const meta=document.getElementById('meta');
    meta.style.display='block';
    meta.innerText=metaMes?`üéØ Voc√™ atinge a reserva no m√™s ${metaMes}`:'‚ùå Reserva n√£o atingida';

  }catch(e){
    console.error('Erro na simula√ß√£o',e);
    alert('Erro inesperado na simula√ß√£o. Verifique os valores informados.');
  }
}

function exportarPDF(){
  const bloco=document.createElement('div');
  bloco.innerHTML=`<h2>Relat√≥rio da Simula√ß√£o de Reserva de Emerg√™ncia</h2>
  <p><strong>Saldo nominal:</strong> valores sem desconto da infla√ß√£o, podendo gerar ilus√£o de crescimento.</p>
  <p><strong>Saldo real:</strong> valores corrigidos pela infla√ß√£o, representando o poder de compra.</p>
  <p><strong>Aporte nominal:</strong> valor fixo que perde for√ßa com a infla√ß√£o.</p>
  <p><strong>Aporte real:</strong> valor corrigido pela infla√ß√£o, mantendo esfor√ßo financeiro.</p>
  <p><strong>Choque inflacion√°rio:</strong> per√≠odo tempor√°rio de infla√ß√£o elevada.</p>
  <p><strong>Dura√ß√£o do choque:</strong> tempo de perman√™ncia da infla√ß√£o acima do normal.</p>
  <p><strong>Perda de renda:</strong> simula√ß√£o de redu√ß√£o parcial ou total da capacidade de aporte.</p>`;
  document.body.prepend(bloco);
  window.print();
  bloco.remove();
}catch(e){console.error(e)}
}

window.addEventListener('load',()=>{try{calcular();}catch(e){console.error(e)}});
</script>
</body>
</html>

